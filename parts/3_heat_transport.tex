\label{chp:heat_transport}
\epigraph{\singlespacing \it ``It seems there is no problem in modern physics for which there are on record as many false starts, and as many theories which overlook some essential feature, as in the problem of the thermal conductivity of [electrically] non-conducting crystals.''}{R.~Peierls, 1960~\cite{Peierls1960}}

As this quote by Rudolf Peierls exemplifies, developing a microscopic theory for heat transport in dielectric crystals was a long-standing problem for solid-state physics in the 20th century. Early attempts to explain this phenomenon sparked by experiments conducted by Eucken comprise those by Einstein, Debye, and Born and von Karman in the early 1910s~\cite{Eucken.1911,Einstein.1911,Debye.1912,Cahill.1988}. However, they failed to explain the experimental findings (Einstein), or could only provide qualitative understanding (Debye). One key insight by Debye missing in the earlier attempt by Einstein is the notion of a \emph{phonon gas},~i.\,e.,~that the collective excitations of the nuclear degrees of freedom show qualitatively similar behavior as molecules in a gas. It was in 1929 that Peierls himself contributed a model for heat transport in solids that was able to explain key experimental findings such as the $1/T$ dependence of a material's thermal conductivity at elevated temperatures, which he could achieve by computing three-phonon scattering due to anharmonic terms in the potential-energy surface~\cite{Peierls.1929}. It took another 80 years until this approach led to the development of a fully \emph{ab initio} computational approach by Broido and coworkers in 2007~\cite{Broido.2007}, using the method of Boltzmann transport equation pioneered by Peierls and further developed in the meantime~\cite{Omini.1996,Omini.1997,Broido.2005}. By the time of writing this work, Boltzmann transport theory is the established way to compute thermal transport properties of dielectric crystals from first principles, and many new, more refined approaches have been developed in recent years~\cite{Feng.2016,Xia.2018,Ravichandran.2018,Simoncelli.2019}.

\newthought{However, Boltzmann transport theory always relies on the phonon gas model} and treats phonon-phonon interactions as perturbative effects due to low-order anharmonic corrections to the potential-energy surface. When dealing with strongly anharmonic materials, this perturbative treatment becomes more and more cumbersome, and sometimes even unjustified, as we will discuss in more detail later. In this chapter, we therefore review heat transport in solids in the framework of Green-Kubo theory without treating the nuclear dynamics as a phonon gas~ \cite{Green.1952,Kubo1957a,Kubo1957b,Helfand.1960,Hardy.1963}.

\section{Introduction}
\label{sec:thermal_conductivity}
Conductive heat transport is the phenomenon of vibrational energy traversing a material when a temperature gradient is applied. As first described by Joseph Fourier in the early 19th century, the heat flux $\b J$ resulting from a stationary temperature gradient $\nabla T$ is directly proportional to this gradient~\cite{Fourier1878}. The proportionality constant is second-rank tensor denoted by $\kappa$ and called the \emph{thermal conductivity}. The defining equation,
\begin{align}
  \b J = - \kappa \nabla T~,
  \label{eq:Fourier}
\end{align}
is called \emph{Fourier's law}. The sign convention is such that the heat flows from ``hot to cold'' in accordance with the second law of thermodynamics. The regime where Eq.\,\eqref{eq:Fourier} is valid is called the \emph{diffusive} regime, as it holds when the temperature gradient is small on microscopic scale, and the sample size is big enough so that boundary effects are negligible~\cite{Kapitza1941a,Antidormi2020}.

It is evident from Eq.\,\eqref{eq:Fourier} that the thermal conductivity $\kappa$ is an explicitly non-equilibrium quantity. As such, it can be related to equilibrium fluctuations by means of the \emph{fluctuation-dissipation theorem}~\cite{Einstein1905a,Nyquist.1928,Callen.1951,Kubo1957a}, resulting in the famous Green-Kubo formula~\cite{Green.1952,Kubo1957b},
\begin{align}
  \kappa^{\alpha \beta} = \frac{V}{k_{\rm B} T^2} \int_{0}^{\infty} \d t ~
    \braket{J^\alpha (t) J^\beta(0)}_{\rm eq}~.
  \label{eq:GreenKubo_0}
\end{align}
This formula relates the temporal fluctuations of the macroscopic heat flux $\b J (t)$ as given by an equilibrium ensemble average of the autocorrelation function, $\braket{J^\alpha (t) J^\beta(0)}_{\rm eq}$, to the associated transport coefficient $\kappa^{\alpha \beta}$, where $\alpha$ and $\beta$ denote the respective Cartesian components. It is however \emph{a priori} unclear how a microscopic description of the appearing quantities can be obtained. To tackle this question in full, we 
%\mscomment{``we'': you or someone else?}
%\FK{``closely following Baroni and coworkers in Ref.\,\cite{Baroni2020a}''. Clarify how many dots I connected}
first show how the Kubo formula emerges in the framework of linear response theory, closely following Baroni and coworkers in Ref.\,\cite{Baroni2020a}. We then present how a microscopic description of heat in terms of a thermal energy density and an associated, locally conserved current follows, before reviewing the necessary steps to define an \emph{ab initio} heat flux~\cite{Carbogno.2016}.



\section{Linear response theory}
The aim of linear response theory is to compute the expectation value of a phase-space observable $B (\Gamma)$ in a system characterized by the many-body Hamiltonian $\mathcal H^0 (\Gamma)$ in presence of an external perturbation $\mathcal H' (\Gamma, t)$ driving the system out of equilibrium, where $\Gamma = \set{\b R, \b P}$ is a shorthand for a point in phase space.\footnote{The notation used in this chapter was introduced in Sec.\,\ref{sec:statistical-mechanics}.}
The full Hamiltonian is written as
\begin{align}
  \mathcal H (\Gamma, t)
   = \mathcal H^0 (\Gamma) + \mathcal H' (\Gamma, t)~,
  \label{eq:lr.H}
\end{align}
where the perturbation $\mathcal H' (\Gamma, t)$ is usually given as
%
\begin{align}
  \mathcal H' (\Gamma, t)= A (\Gamma) F(t)~,
  \label{eq:lr.H_AF}
\end{align}
%
with $A(\Gamma)$ representing an operator coupling to the system, and $F(t)$ is an explicitly time-dependent force function.

The task is to compute the expectation value of $B$ as defined in Eq.\,\eqref{eq:phase.space.average},
%
\begin{align}
  \braket{B (t)}
    = \int \d \Gamma ~ B (\Gamma) f(\Gamma, t)~,
  \label{eq:lr.B.1}
\end{align}
%
in the presence of the perturbation $\mathcal H'$, where $f (\Gamma)$ is the canonical distribution function characterizing the statistical ensemble at inverse temperature $\beta$.

\newthought{In the limit of linear response},~i.\,e.,~in the limit of a small \emph{external} perturbation $\mathcal H'$,\footnote{This is not to be confused with a perturbation expansion of $\mathcal H^0$, which is treated exactly here.} the expected response of the phase space observable $B$ to the system Hamiltonian defined in Eq.\,\eqref{eq:lr.H} is given as
%
\begin{align}
\braket{B (t)}
%    &= \int \d \Gamma ~  B (\Gamma) \Delta f (\Gamma, t) \\
%    &= - \beta \int_{-\infty}^t 
%      \int \d \Gamma ~  
%       B (\Gamma) \, {\rm e}^{-\im \mathcal L^0 (t - t')} \dot{A}(\Gamma)
%       f^0(\Gamma) F(t') ~ \d t' \\
    = - \beta \int_{-\infty}^t 
      \braket{B(\Gamma_t) \dot{A} (\Gamma_{t'})}_{0} F(t') ~ \d t'~,
  \label{eq:lr.dB}
\end{align}
%
where $\braket{\cdot}_{0}$ denotes a phase-space average with respect to the unperturbed canonical distribution function
%
\begin{align}
  f^0 (\Gamma) 
    = \frac{1}{\mathcal{Z}^0} {\rm e}^{- \beta \mathcal H^0 (\Gamma)}~,
  \label{eq:lr.f0}
\end{align}
where the partition sum $\mathcal{Z}_0$ normalizes the phase-space integral \mbox{$\int \d \Gamma f^0 (\Gamma)$}.
The notation implies that for each phase-space point $\Gamma$ in the ensemble, $B (\Gamma)$ and $\dot{A} (\Gamma)$, the total time derivative of $A (\Gamma)$, are evaluated at phase-space points separated in time by $t-t'$~\cite[p.\,498]{Tuckerman}.
%it was used that $a(t) = {\rm e}^{\im \mathcal L^0 t} a(0) = a(0) {\rm e}^{-\im \mathcal L^0 t}$, and  as before. 
%It is evident from this equation that the time propagation of the observables $\dot {A}$ and $B$ 
The time propagation of phase-space points is generated by $\mathcal H^0$ and therefore given by Hamilton's equations of motion with conserved energy as defined in Eq.\,\eqref{eq:stat.eom}. The phase-space average $\braket{\cdot}_{0}$ on the other hand corresponds to a canonical ensemble average with respect to the distribution function $f^0$ defined in Eq.\,\eqref{eq:lr.f0}. A derivation of Eq.\,\eqref{eq:lr.dB} is given in Chp.\,\ref{app:linear_response} in the appendix.



\subsection{Locally conserved densities and currents}
Macroscopic properties of matter are often \emph{extensive},~i.\,e.,~they scale with the system size, and can be described by a locally conserved \emph{density}~\cite{Baroni2020a}. Taking the general property $A$ represented by the phase-space observable $A(\Gamma_t)$ evaluated at a time $t$ as an example, we define
\begin{align}
  A (\Gamma_t) = \int_V a (\b r, \Gamma_t) \, \d^3 r~,
  \label{eq:lr.A}
\end{align}
where $a(\b r, \Gamma_t)$ is a suitably chosen \emph{local density} associated with the observable $A$. The notation $\Gamma_t$ was introduced in Sec.\,\ref{sec:phase_space} to highlight that $A$ is implicitly time-dependent because the phase-space configuration $\Gamma$ evolves in time.
%When no ambiguity arises, we can therefore just write $a (\b r, t)$.\footnote{
%	Notation for phase-space functions $f (\Gamma)$:
%	\begin{align*}
%	f(t) &\equiv f(\Gamma (t)) \\
%	\frac{\partial f}{\partial t} &= \frac{\d f (\Gamma (t))}{\d t} \equiv \dot{f}(t)
%	\end{align*}
%}
The locally conserved density fulfills a continuity equation
\begin{align}
  \partial_t \, a(\b r, \Gamma_t) = - \b \nabla \cdot \b j (\b r, \Gamma_t)~,
  \label{eq:lr.continuity.1}
\end{align}
where $\b j (\b r, \Gamma_t)$ is the associated local current. From the local current, the macroscopic flux is obtained by spatially averaging over the system volume,
\begin{align}
  \b J (\Gamma_t)
    = \frac{1}{V} \int_V \d^3 r ~ \b j (\b r, \Gamma_t)~.
  \label{eq:lr.J(t)}
\end{align}
Likewise we formulate a local version of the perturbing Hamiltonian initially defined in Eq.\,\eqref{eq:lr.H_AF},
\begin{align}
	\mathcal H' (\Gamma_t, t) = \int \d^3 r ~ a (\b r, \Gamma_t) v(\b r, t)~,
	\label{eq:lr.H'}
\end{align}
where $a(\b r, \Gamma_t)$ represents the density of interest as introduced above, and $v(\b r, t)$ is the local driving force coupling to the system via the density $a (\b r, \Gamma_t)$.

The local version of the linear-response formula given in Eq.\,\eqref{eq:lr.dB} for the expectation value of a given local flux $\bf j$ at time $t$ reads:\footnote{Take \mbox{$B \equiv \b J$} with $\braket{B} \equiv \braket{\b J} = 0$~.}
\begin{align}
%j^\alpha (\b r , t) 
%	& \equiv 
\braket{j^\alpha (\b r, t)}
	&= - \beta \int_{-\infty}^{t} \d t' \int_V \d^3 r' ~ \braket{
			j^\alpha (\b r, \Gamma_t) \dot{a} (\b r', \Gamma_{t'})
		}_0 v (\b r', t')~.
	\label{eq:lr.ja.1}
\end{align}
The time derivative of the density can be eliminated by using the continuity equation~\eqref{eq:lr.continuity.1}, $\dot a = - \partial'_\beta j^\beta$ where $\partial'_\beta = \partial/\partial r^{\prime \beta}$, and integrating by parts, so that
\begin{align}
\braket{j^\alpha (\b r , t) }
&= - \beta \int_{-\infty}^{t} \d t' \int_V \d^3 r' ~ \braket{
	j^\alpha (\b r, \Gamma_t) j^\beta (\b r', \Gamma_{t'})
}_0 \partial'_\beta v (\b r', t')~,
\label{eq:lr.ja.2}
\end{align}
where a boundary term was neglected.\footnote{Boundary terms scale proportional to the surface of the integration volume and therefore become negligible in the thermodynamic limit $V \to \infty$.}
If we now assume the external driving force $v (\b r, t)$ to be constant in time and linearly varying in space such that
\begin{align}
	\partial_\beta v (\b r, t) \equiv v_\beta~,
	\label{eq:lr.force}
\end{align}
and spatially average over Eq.\,\eqref{eq:lr.ja.2} with $\frac{1}{V} \int_V \d^3 r$, we arrive at
% \REM{check sign}: there is a double minus: i) continuity equation, ii) integration by parts. correct?
\begin{align}
	J^\alpha 
	\equiv \braket{J^\alpha}
		&= -\beta V \int_{0}^{\infty} 
		\d t
		\braket{
		J^\alpha (\Gamma_t) J^\beta (\Gamma_{0})
	}_0 
	v_\beta~,
	\label{eq:lr.J}
\end{align}
where the stationarity in time was used to shift the lower bound of the integral to $t=0$.
This resembles the well-known macroscopic transport equation~\cite{Onsager1931a}
\begin{align}
	J^\alpha =  L^{\alpha \beta} F_\beta~,
		\label{eq:lr.LF}
\end{align}
where we identify
\begin{align}
	L^{\alpha \beta}
		= \frac{V}{k_{\rm B}} \int_{0}^{\infty} 
		\d t \braket{J^\alpha (\Gamma_t) J^\beta (\Gamma_{0})}_0 ~,
	\label{eq:lr.L}
\end{align}
and
\begin{align}
	F_\beta
		= - \frac{v_\beta}{T}~.
	\label{eq:lr.F}
\end{align}
Here, $J^\alpha$ is the macroscopic generalized current associated with the extensive property $A$, $F_\beta$ is the thermodynamic force, and $L^{\alpha \beta}$ is the associated conductance tensor~\cite{Onsager1931a,Baroni2020a}.

\section{Thermal conductivity}
\label{sec:Thermal.Conductivity}
After this general exposition, let us now look at the example of the total energy of the system and its associated energy density,
\begin{align}
	E = \int_V \d^3 r ~ e(\b r)~.
	\label{eq:lr.E}
\end{align}
We are interested in the occuring flux in the presence of an inhomogeneous temperature, $T(\b r) = T + \Delta T(\b r)$, which couples linearly to the energy density  $e (\b r)$, so that\footnote{$E$ and $\mathcal H(\Gamma)$ are related by $E = \braket{\mathcal H}$. The same holds for the occurring densities $e(\b r)$ and $e (\b r, \Gamma)$.}\footnote{The situation can viewed as a \emph{stationary nonequilibrium state}. The general theory has been worked out by McLennan~\cite{Mclennan.1959,Mclennan.1960}. See also the discussion by Zwanzig in Ref.~\cite{Zwanzig.1965}.}
\begin{align}
	\mathcal H (\Gamma) = \frac{1}{T} \int \d^3 r ~ T (\b r) e(\b r, \Gamma) 
		\equiv \mathcal H^0 (\Gamma) + \mathcal H' (\Gamma)~,
\end{align}
with
\begin{align}
	\mathcal H' (\Gamma) = \frac{1}{T} \int \d^3 r ~ \Delta T (\b r) e(\b r, \Gamma)~.
	\label{eq:lr.Hp.temp}
\end{align}
As earlier in Eq.\,\eqref{eq:lr.force}, we assume $\Delta T(\b r)$ to vary linearly in space, so that the thermodynamic force is given by
\begin{align}
	v_\beta = \frac{1}{T} \partial_\beta T (\b r) 
		\stackrel{\eqref{eq:lr.F}}{\implies}
	F_\beta = - \frac{1}{T^2} (\b \nabla T)_\beta ~.
	\label{eq:lr.F.temp}
\end{align}
Using the general transport equation defined in Eq.\,\ref{eq:lr.LF} with the conductance given by Eq.\,\eqref{eq:lr.L} and $F$ as defined above, we obtain
\begin{align}
	J^\alpha 
		&= - \kappa^{\alpha \beta} (\b \nabla T)_\beta~,
	\label{eq:lr.J.2}
\end{align}
where $\kappa^{\alpha \beta}$ denotes the \emph{thermal conductivity tensor} defined as
\begin{align}
	\kappa^{\alpha \beta}
		&=
		\frac{V}{k_{\rm B} T^2} \int_{0}^{\infty} 
		\d t \braket{J^\alpha (\Gamma_t) J^\beta (\Gamma_{0})}_0 ~,
	\label{eq:GreenKubo}
\end{align}
that is, the Green-Kubo formula for the thermal conductivity $\kappa$.

\section{Heat flux definition}
In order to evaluate the thermal conductivity by means of the Green-Kubo formula, Eq.\,\eqref{eq:GreenKubo}, the  heat flux observable $\b J (t)$ needs to be defined.\footnote{From now on, all time dependence is to be understood as the implicit time dependence of phase-space observables on the time evolution of a phase-space point, $f(t) = f(\Gamma_t)$.} We do so by starting from the continuity equation again,
\begin{align}
	\dot{e} (\b r) = - \b \nabla \cdot \b j (\b r)
	\label{eq:hf.cont}
\end{align}
and perform a Fourier transform in space defined by the pair of equations
\begin{align}
	e(\b r) 
		&= \int \d^3 q ~ e(\b q) \, {\rm e}^{\im \b q \cdot \b r} ~,
		\label{eq:hf.ft.r} \\
	\Leftrightarrow
	e(\b q) 
		&= \frac{1}{V} \int \d^3 r ~ e(\b r) \, {\rm e}^{-\im \b q \cdot \b r} ~,
	\label{eq:hf.ft.2}
\end{align}
so that the continuity equation can be rewritten for the Fourier components as
\begin{align}
	\dot{e} (\b q)
		= - \im \b q \cdot \b j (\b q)~.
	\label{eq:hf.ft.cont.q}
\end{align}
We split the total current into a longitudinal, heat-carrying component $\b j_{\parallel}$ and a transverse current $\b j_{\perp}$,
\begin{align}
	\b j = \frac{\b q}{q} j_{\parallel} + \b j_{\perp} \quad\text{where}\quad \b q \cdot \b j_{\perp} = 0~,
\end{align}
so that
\begin{align}
	\b j_{\parallel} (\b q)
		= \im \frac{\b q}{q^2} \dot{e} (\b q)~.
  \label{eq:hf.j.parallel}
\end{align}
As before, the macroscopic heat flux is given by a spatial average of the (longitudinal) current,
\begin{align}
	\b J = \frac{1}{V} \int \d^3 r ~ \b j_{\parallel} (\b r) = \b j_{\parallel} (\b q \to 0)~,
	\label{eq:hf.J.1}
\end{align}
where it was used that, by definition of the Fourier transform, the integral over the system volume equals the long wavelength limit of the current in reciprocal space. The long wavelength limit for the time derivative of the local energy density can be obtained by Taylor expanding in $\b q$
\begin{align}
	\dot{e} (\b q) 
		= \lim_{\b q \to 0} \int \d^3 r \left(\cancel{1} - \im \b q \cdot \b r + (\b q \cdot \b r)^2 + \cdots \right) \dot{e} (\b r)~,
	\label{eq:hf.e.lw}
\end{align}
where the first term in the expansion is excluded since the total energy $E$ is conserved in time.\footnote{Using the  Leibniz rule,
\begin{align*}
	\int \d^3 r \, \dot{e} (\b r) = \frac{\d}{\d t} \int \d^3 r \, e (\b r) = \frac{\d}{\d t} E = 0~.
\end{align*}
}
After multiplying $\dot e$ with $\im \b q / q^2$ according to Eq.\,\eqref{eq:hf.j.parallel} and taking the $\b q \to 0$ limit, we obtain
\begin{align}
	\b J (t) 
		= \frac{1}{V} \int \d^3 r ~ \b r \, \dot{e} (\b r, t)
		= \frac{1}{V} \frac{\d}{\d t} \int \d^3 r ~ \b r \, e (\b r, t)
	~,
	\label{eq:hf.J}
\end{align}
i.\,e.,~the heat flux is given as the first moment of the time derivative of the local energy density. Alternatively, one can view the heat flux as the time derivative of the energy barycenter by moving the time derivative outside the integral.

In force-field approaches, it is common to adopt the latter approach and split the energy density into atomic contributions $E = \sum_I E_I$ as
\begin{align}
	e (\b r, t ) = \sum_I E_I (t) \delta (\b r - \b R_I (t))~.
	\label{eq:hf.e.atomic}
\end{align}
The heat flux is then given by~\cite{Helfand.1960}
\begin{align}
	\b J (t) 
		= \frac{1}{V} \frac{\d}{\d t} \sum_I E_I(t) \b R_I(t)
		% = \frac{1}{V} \sum_I \dot{E}_I (t) \b R_I (t) + E_I (t) \dot{\b R}_I (t)~,
		= {\bf J}^{\rm pot} (t) + {\bf J}^{\rm kin} (t)~,
	\label{eq:hf.J.atomic}
\end{align}
with a \emph{potential} or \emph{virial} current
\begin{align}
	{\bf J}_{\rm pot} (t)
		= \frac{1}{V} \sum_I \dot{E}_I (t) \b R_I (t)~,
	\label{eq:J_pot}
\end{align}
and a \emph{kinetic} or \emph{convective} current
\begin{align}
	{\bf J}_{\rm kin} (t)
		= \frac{1}{V} \sum_I E_I (t) \dot{\b R}_I (t)~.
	\label{eq:J_kin}
\end{align}
While the kinetic flux becomes increasingly important and even dominant in liquids and gases with substantial convection~\cite{Cheng.2020}, it is typically neglected in non-convective solids, as it was shown several times in the literature that its contribution to thermal conductivity is orders of magnitude lower compared to the virial flux~\cite{Vogelsang.1987,Kinaci.2012}. However, also in solids it is not strictly vanishing, and discarding the kinetic flux as defined in Eq.\,\eqref{eq:J_kin} therefore is an approximation which we discuss in the following.

\subsection{Gauge invariance of heat flux definitions}
\label{sec:gauge_invariance}
As seen above, the local current is only defined up to a non-heat carrying contribution $\b j_{\perp}$. Likewise, the energy density is only defined up to terms that keep the total energy integral unchanged. The choice of a local energy partitioning as,~e.\,g.,~given by Eq.\,\eqref{eq:hf.e.atomic} is therefore not unique, and different partitioning schemes will lead to differing heat fluxes. However, the thermal conductivity obtained after integrating the respective autocorrelation functions will be the same. In particular, Ercole \emph{et al.} have shown in Ref.\,\cite{Ercole.2016} that two heat fluxes differing by the time derivative of a \emph{bounded} vector field,
\begin{align}
  \tilde{\b J} (t) = \b J (t) + \frac{\d}{\d t} \b P (t)~,
\end{align}
can differ in time, and in general also their autocorrelation functions will differ. The thermal conductivity obtained from both fluxes will however be the same, which can be viewed as a \emph{gauge invariance principle} for the heat flux. This property can be used to discard terms from the flux that do not contribute to the thermal conductivity and thereby reduce noise~\cite{Marcolongo.2020}. 
%We will show practical implications of this ``gauge invariance principle'' later in the results part.

\newthought{As an example of immediate practical importance}, we rewrite the heat flux expression presented in Eq.\,\eqref{eq:hf.J.atomic} as
\begin{align}
	\b J (t) 
%		&= \frac{1}{V} \sum_I \left[ \b R_I^0 \fD{\dot{E}}_I + \b U_I \dot{E}_I + \dot{\b U}_I E_I\right] \\
	&= \frac{1}{V} \sum_I \b R_I^0 \fD{\dot{E}}_I + { \frac{1}{V} \frac{\d}{\d t} \sum_I \b U_I E_I}~,
	\label{eq:J_gauge_1}
\end{align}
where the instantaneous positions ${\bf R} (t)$ are split into a fixed reference ${\bf R}^0$ and a displacement field ${\bf U} (t)$~\cite{Isaeva.2019}. When all the atomic displacements $\set{{\bf U}_I}$ are bounded,~i.\,e.,~in the absence of convective terms, the second term in Eq.\,\eqref{eq:J_gauge_1} fulfills the condition of being the time derivative of a bounded vector field and therefore does not contribute to the thermal conductivity by the gauge invariance principle. Using the definition of the kinetic flux in Eq.\,\eqref{eq:J_kin}, the second, non-contributing term can be written as
\begin{align}
	\frac{1}{V} \frac{\d}{\d t} \sum_I \b U_I E_I
		= {\bf J}_{\rm kin} + {\bf J}_{\rm res}
	\label{eq:J_gauge_2}
\end{align}
with a residual flux %${\bf J}^{\rm res} = \frac{1}{V} \sum_I \b U_I \dot E_I$
\begin{align}
	{\bf J}_{\rm res} (t)
		= \frac{1}{V} \sum_I \b U_I \dot E_I~.
	\label{eq:J_gauge_3}
\end{align}
This makes clear that, in the absence of convection, the contribution of ${\bf J}_{\rm kin}$ to thermal conductivity does not vanish alone, as argued in the previous section, but the \emph{joint} contribution of ${\bf J}_{\rm kin}$ and ${\bf J}_{\rm res}$ vanishes. By the reverse argument, one can argue that whenever the contribution of ${\bf J}_{\rm kin}$ to thermal conductivity can be neglected in a solid, the contribution of ${\bf J}_{\rm res}$ must vanish as well. In consequence, the heat flux in non-diffusing solids is given by
\begin{align}
	\b J^{\rm non-convective} (t) 
		&= \frac{1}{V} \sum_I \b R_I^0 \fD{\dot{E}}_I
		\approx {\bf J}_{\rm pot} (t)~,
	\label{eq:J_tot_solid}
\end{align}
where the difference between left- and right-hand side is given by ${\bf J}_{\rm res}$ which can be neglected whenever the kinetic flux can be neglected, as discussed above. The exact definition for the non-diffusive current in terms of fixed reference positions $\set{{\bf R}^0_I}$ was already used by Ladd and coworkers in Ref.\,\cite{Ladd.1986} to simplify the occuring expressions. An in-depth discussion of the subtleties arising in the definition of an exact expression for the non-convective heat flux in solids can be found in Sec.~2.3.1 and appendix A of Ref.~\cite{ErcoleThesis}.

\newthought{A final remark concerning the heat flux definition} is in order: One might argue that the expression in Eq.\,\eqref{eq:J_tot_solid} is a total time derivative of ${\bf P} = \frac{1}{V}  \sum_I {\bf R}_I^0 \fD E_I$, and therefore vanishes by the aforementioned gauge invariance principle as well. However, this is not the case in an infinite solid, since the atomic configuration $\set{{\bf R}_I}$ is not bounded. The sum over atomic positions is therefore not well defined in the first place and remains to be understood as a symbolic representation of an actual energy partitioning scheme that needs to be cast in a boundary-insensitive form for any practical application of Eq.\,\eqref{eq:J_tot_solid}.\footnote{The author thanks Stefano Baroni for an insightful discussion clarifying this point.}
%\mscomment{wasn't this already discussed in the literature?}
%\FK{Iffyness yes, as clarification why gauge invariance doesn't make everything vanish I find it helpful}

\section{Ab initio heat flux}
\label{sec:ab_initio_heat_flux}
The above formulas are readily applied when empirical force fields are used to describe the atomic interactions, as an atomic partitioning of the total energy is trivial in that case, although care must be taken in deriving the correct formulae nevertheless~\cite{Fan.2015,Boone.2019}. An \emph{ab initio} derivation of heat flux on the other hand was a long-standing problem because it was not clear how an expression like Eq.\,\eqref{eq:J_tot_solid} can be obtained when no atomic partitioning is available~\cite{Stackhouse.2010}. This problem was solved when Marcologno \emph{et al.} and Carbogno \emph{et al.} independently arrived at well-defined heat flux expressions in \mbox{\emph{ab initio}} frameworks~\cite{Marcolongo.2016,Carbogno.2016}. We adopt the latter approach in the following, but present a derivation that slightly differs from Ref.\,\cite{Carbogno.2016},~i.\,e.,~by starting from Eq.\,\eqref{eq:hf.J} instead of Eq.\,\eqref{eq:hf.J.atomic}, and using the phase-space formalism developed in this chapter.

% \paragraph{Derivation of ab initio Heat Flux}
To evaluate Eq.\,\eqref{eq:hf.J},\footnote{Recall Eq.\,\eqref{eq:hf.J}:$$\b J (t) 
	= \frac{1}{V} \int \d^3 r ~ \b r \, \dot{e} (\b r, t)~.$$} we need a definition of the time derivative of the energy density. We do so by first going back to the many-body Hamiltonian for a configuration $\Gamma = (\b R, \b P)$ given by
\begin{align}
	\mathcal H (\Gamma) = \sum_I \frac{\b P_I^2}{2 M_I} + \mathcal V(\b R) 
		~\equiv~ \int \d^3 r ~ e (\b r, \Gamma)~,
  \label{eq:hf.ai.H}
\end{align}
where $e (\b r, \Gamma)$ is an appropriately chosen energy density yielding the total energy of the given system. Accordingly, the time derivative of the entire expression reads
\begin{align}
	\dot{\mathcal H} (\Gamma)
		= \sum_I \b F_I \cdot \dot{\b R}_I 
		+ \sum_I \frac{\partial \mathcal V(\b R)}{\partial \b R_I} \cdot \dot{\b R}_I
			\label{eq:hf.ai.Hdot}
		\equiv
			\int \d^3 r ~ \dot{e} (\b r , \Gamma)~.
\end{align}
Since the energy is conserved, the time derivate of the Hamiltonian vanishes, and therefore $\dot{e} (\b r, \Gamma)$ needs to integrate to zero.
As explained in Sec.\,\ref{sec:HellmannFeynman}, the force derived from the BO potential-energy surface $\mathcal V ({\bf R})$ appearing in Eq.\,\eqref{eq:hf.ai.Hdot} has a nuclear and an electronic contribution given by the two terms in Eq.\,\eqref{eq:hellmannfeynman.force}, so that
\begin{align}
	\b F_I
		&%= - \frac{\partial V (\b R)}{\partial \b R_I}  
			= \int \d^3 r ~ \b f_I^{\rm el} (\b r) + \sum_{J \neq I} \b F_{IJ}^{\rm Nuc}~, \quad\text{with}
		\label{eq:hf.ai.F}\\
	\b f_I^{\rm el} (\b r)
		&= - n(\b r) Z_I \frac{\b R_I - \b r}{\lvert \b R_I - \b r \rvert^3}~,
		\label{eq:hf.ai.Fel}
		\quad\text{and} \\
	\b F_{IJ}^{\rm Nuc}
		&= Z_I Z_J \frac{\b R_I - \b R_J}{\lvert \b R_I - \b R_J \rvert^3}~.
		\label{eq:hf.ai.Fnuc}
\end{align}
Therefore, Eq.\,\eqref{eq:hf.ai.Hdot} can be written as the sum of three terms that sum to zero as required,
\begin{align}
	\dot{\mathcal H} (\Gamma)
		&= \underset{I)}{\underbrace{\sum_I \b F_I \cdot \dot{\b R}_I}} ~ 
			 \underset{II)}{\underbrace{-\sum_{I} \int \d^3 r ~ \b f_I^{\rm el} (\b r) \cdot \dot{\b R}_I}} ~
			 \underset{III)}{\underbrace{-\sum_{\substack{I, J \\ J \neq I}} \b F^{\rm Nuc}_{IJ} \cdot \dot{\b R}_I}}~.
\end{align}
We use these terms to define three contributions to the local density $\dot{e} (\b r)$ as
\begin{subequations}
\begin{align}
	\text{I):}&&
		\dot{e}_{\rm kin} (\b r) &= \sum_I \b F_I \cdot \dot{\b R}_I \, \delta (\b R_I - \b r)~, \\
	\text{II):}&&
		\dot{e}_{\rm el} (\b r)  &= -\sum_{I} \b f_I^{\rm el} (\b r) \cdot \dot{\b R}_I~, \\
	\text{III):}&&
		\dot{e}_{\rm Nuc} (\b r) &= -\sum_{\substack{I, J \\ J \neq I}} \b F^{\rm Nuc}_{IJ} \cdot \dot{\b R}_I \, \delta (\b R_J - \b r)~.
\end{align}
\label{eq:hf.ai.densities}
\end{subequations}
Pictorially, the kinetic contribution $\dot{e}_{\rm kin} (\b r)$ is assigned to atom $I$ in the sum, the electronic contribution $\dot{e}_{\rm el} (\b r)$ is assigned to the local electron density at $\b r$ and is therefore a local quantity per definition, and the nuclear contribution $\dot{e}_{\rm Nuc} (\b r)$ is assigned to atom $J$ in analogy to the electronic case. It is easily verified that the sum of these contributions integrate to zero. Their first moment however gives a non-vanishing heat flux by Eq.\,\eqref{eq:hf.J},~i.\,e.,
\begin{align}
	\b J (\Gamma)
		% &= \frac{1}{V} \int \d^3 r ~ \b r \, \dot{e} (\b r, \Gamma) \\
		&= \frac{1}{V} \int \d^3 r ~ \b r \left( \dot{e}_{\rm kin} (\b r) + \dot{e}_{\rm el} (\b r) + \dot{e}_{\rm Nuc} (\b r)  \right) \\
		&= \frac{1}{V} \sum_I
			\left( 
				\b R_I \b F_I \cdot \dot{\b R}_I
				- \int \d^3 r ~ \b r \, \b f_I^{\rm el} (\b r) \cdot \dot{\b R}_I
				- \sum_{J \neq I} \b R_J \b F^{\rm Nuc}_{IJ} \cdot \dot{\b R}_I
			\right)~.
\end{align}
By using Eq.\,\eqref{eq:hf.ai.F} in the first summand of the above equation, Eq.\,\eqref{eq:hf.ai.Fel} for the second, and Eq.\,\eqref{eq:hf.ai.Fnuc} for the third, we arrive at
\begin{align}
	J^\alpha (\Gamma) \nonumber
		=  \sum_{I, \alpha} \frac{Z_I}{V}
			&\left\{ 
				\sum_{J \neq I} Z_J \frac{(R_I^\alpha - R_J^\alpha) (R_I^\beta - R_J^\beta)}{\lvert \b R_I - \b R_J \rvert^3} \right. \nonumber \\
				&~\left.- \int \d^3 r ~ n(\b r) \frac{(R_I^\alpha - r^\alpha) (R_I^\beta - r^\beta)}{\lvert \b R_I - \b r \vert^3}
			\right\}
			\dot{R}^\beta_I~,
	\label{eq:hf.ai.J}
\end{align}
where the Cartesian indices of the expressions have been written out explicitly.
As shown in Ref.\,\cite{Carbogno.2016}, this expression can be written in terms of atomic contributions to the stress tensor $\sigma$ defined by
\begin{align}
  \sigma^{\alpha \beta} 
    = - \frac{\partial V ({\bf R})}{\partial \varepsilon_{\alpha \beta}}
    = \sum_I \sigma_I^{\alpha \beta}~,
  \label{eq:hf.sigma}
\end{align}
with
\begin{align}
  \sigma_I^{\alpha \beta}
    = \frac{Z_I}{V}
        \left\{ 
        \sum_{J \neq I} Z_J \frac{(R_I^\alpha - R_J^\alpha) (R_I^\beta - R_J^\beta)}{\lvert \b R_I - \b R_J \rvert^3}
        - \int \d^3 r ~ n(\b r) \frac{(R_I^\alpha - r^\alpha) (R_I^\beta - r^\beta)}{\lvert \b R_I - \b r \vert^3}
        \right\}~.
  \label{eq:hf.sigma_I}
\end{align}
%
This can be rationalized by using the same steps that led to the Hellmann-Feynman expression for the position derivative in Eq.\,\eqref{eq:hellmannfeynman.force}, and noting that
%
\begin{align}
  \frac{\partial f (\b r_1 - \b r_2)}{\partial \varepsilon_{\alpha \beta}}
    = \frac{\partial f (\b r_1 - \b r_2)}{\partial r_1^\alpha} (r_1^\beta - r_2 ^\beta)~,
  \label{eq:strain.derivative}
\end{align}
%
as discussed in detail in Ref.\,\cite{Knuth.2015}. 

The atomic stress contributions $\sigma_I$ are functionals of the electron density and atomic configuration and therefore can be computed in \emph{ab initio} frameworks, for example in the all-electron, numeric atomic orbital electronic structure code \emph{FHI-aims}~\cite{FHI-aims,Knuth.2015}.\footnote{We mention in passing that in practical implementations, additional contributions to $\sigma_I$ need to be computed to account for basis set dependent Pulay terms just like in the computation of other gradients of the total energy. See again Ref.\,\cite{Knuth.2015} for a comprehensive list of the arising terms.} 
The final result for the \emph{ab initio} heat flux used in this work is therefore
\begin{align}
	{\bf J}_{\rm ai} (t) = \sum_I \sigma_I (t) \dot{{\bf R}}_I~,
	\label{eq:J_ai}
\end{align}
where $\sigma_I (t)$ is Eq.\,\eqref{eq:hf.sigma_I} evaluated for the configuration ${\bf R} (t)$.

\newthought{To conclude, we like to point out} that by using the time derivative of the energy density, we neglect convective contributions to the flux from the very beginning. The present \emph{ab initio} heat flux is therefore valid for solids with vanishing or negligible mass diffusion, as discussed earlier.

% \CITE{[1] O. H. Nielsen and R. M. Martin, Phys. Rev. B 32, 3780 (1985).?}

\section{Heat flux in the harmonic approximation}
We now discuss heat flux in the harmonic approximation. This work was pioneered by Debye and Peierls~\cite{Debye.1914,Peierls.1929}, with a formal derivation first presented by Hardy~\cite{Hardy.1963}. It allows to deduct several important conclusions about thermal transport in solids, and the insights will later be used to boost convergence of non-perturbative \emph{ab initio} Green Kubo simulations.

\newthought{We start from the gauge-invariant heat flux expression} for solids as defined in Eq.\,\eqref{eq:J_tot_solid},~i.\,e.,
\begin{align}
	\b J (t) 
		= \frac{1}{V} \sum_I \b R_I^0 \fD{\dot{E}}_I~.
		\label{eq:J_ha_0}
\end{align}
The atomic energy contribution $E_I$ expressed in mass-scaled displacements $\set{\b u_I}$ and momenta $\set{\b p_I}$ reads
\begin{align}
	E_I = \halb p_I^2 + \halb \sum_J D_{I \alpha , J \beta} \, u_I^\alpha u_J^\beta~,
\end{align}
with the dynamical matrix $D_{IJ}$, so that\marginnote{The harmonic forces are
	\begin{align*}
	\dot{p}_{I\alpha}
	= - \frac{\partial E}{\partial u_I^\alpha} 
	= - \sum_J D_{I \alpha , J \beta} \, u_J^\beta~,
	\end{align*}
and in mass-weighted coordinates
	$$\dot{u}_I^\alpha = p_I^\alpha~.$$
}
\begin{align}
	\dot E_I 
		&= \sum_J \dot{p}_{I\alpha} p_I^\alpha 
		+ \halb \sum_J D_{I \alpha , J \beta} \, 
			\left( p_I^\alpha u_J^\beta + u_I^\alpha p_J^\beta\right) \nonumber \\ 
		&= -\halb \sum_J D_{I \alpha , J \beta} \, 
		\left( p_I^\alpha u_J^\beta - u_I^\alpha p_J^\beta\right) ~.
		\label{eq:dotE_I}
\end{align}
Using this expression for the time derivative of the atom-resolved harmonic energy  in Eq.\,\eqref{eq:J_ha_0} leads to a heat flux of the form
\begin{align}
    \b J_{\rm ha} (t) = - \frac{1}{2V} \sum_{IJ} (\b R_I^0 - \b R_J^0) D_{I \alpha, J \beta} \, p_I^\alpha (t) u_J^\beta (t)~,
   \label{eq:J_ha_r}
\end{align}
which is boundary-insensitive as required since only differences of positions enter.
We express the displacements $\set {\b u_I}$ and velocities $\set{\b p_I}$ in terms of the complex mode amplitudes $a_s (t)$ introduced in Eq.\,\eqref{eq:u_s.amplitudes.periodic} in Sec.\,\ref{sec:dynmat.periodic},
\begin{align}
    \b u_I (t) 
	    &= ~\sum_s \frac{1}{\sqrt{2 \omega_s}} \b e^\ast_{s I} \left[ \D a_{-s} (t) + \fD a_s (t)\right]~,\quad\text{and} \\
	  \b p_I (t) 
		  &= \sum_s ~\im \sqrt{\frac{\omega_s}{2}} ~ {\b e}_{s I} \left[ \D a_{-s} (t) - \fD a_s (t) \right]~,
\end{align}
where we remind of the shorthand notation $s = (b, {\bf q})$ with band index $b$ and wave vector $\bf q$ summarized in the joint mode label $s$. Using the mode amplitudes, the harmonic heat flux reads
\begin{align}
    \b J_{\rm ha} (t) 
	    %&= \halb \sum_{ss'} \b v_{ss'} \omega_{s} \D u_s (t) p_{s'} (t) \\
	    &= \frac{1}{2V} \sum_{ss'} \b v_{ss'} \omega_{s} \left( \D a_{-s} + \fD a_{s}  \right) \left( \D a_{s'} - \fD a_{-s'}  \right)~,
	  \label{eq:J.ha}
\end{align}
with the generalized group velocity
\marginnote{With the shorthand notation $s=(b, \b q)$ and $I = (i, \b L)$, we find that the diagonal term $\b v_s = \b v_{ss'}$ is indeed the group velocity:
	\begin{align*}
		\b v_{s} 
			&= \frac{\partial \omega_s}{\partial \b q}  = \frac{1}{2 \omega_s} \frac{\partial \omega_s^2}{\partial \b q} \\
			&= \frac{1}{2 \omega_s} \sum_{ij} e^\ast_{s, i \alpha} \frac{\partial D_{i \alpha, j \beta} (\b q)}{\partial \b q} e_{s, j \beta} \\
			&= \frac{1}{2 \omega_s} \sum_{I, J} \im \left( \b R^0_{I} - \b R^0_{J} \right)
			D_{I \alpha, J \beta}	e^\ast_{s, I \alpha} e_{s, J \beta}~.
	\end{align*}}
\begin{align}
	\b v_{ss'}
		&= \frac{1}{2 \sqrt{\omega_s \omega_{s'}}} \sum_{IJ} \im (\b R^0_I - \b R^0_J) D_{I \alpha, J \beta} e^\ast_{s, I \alpha} \fD e_{s', J \beta}~.
\end{align}
Using that $\b v (- \b q) = - \b v (\b q)$, %and defining the mode occupation \mbox{$n_s (t) \equiv \D a_s (t) \fD a_s (t)$}, 
the diagonal contribution ($s=s'$) to the flux reads
\begin{align}
	\b J_{\rm ha-diag} (t) 
%		= \halb \sum_{s} \fD{\b v}_{s} \fD \omega_{s} \D p_s (t) u_{s} (t)
		= \frac{1}{V} \sum_{s} \fD {\b v}_{s} \omega_{s} ~ \D a_s (t) \fD a_s (t)
		\equiv \frac{1}{V} \sum_{s} E_s (t)  {\bf v}_{s}~,
	\label{eq:J.ha.diag}
\end{align}
where the mode energy $E_s = \omega_s \D a_s \fD a_s$ was used.
This result is the familiar phonon heat flux operator (when setting $\hbar = 1$), where $\D a_s (t) \fD a_s (t) \equiv n_s(t)$ is the instantaneous mode occupation as defined in Eq.\,\eqref{eq:n_s(t)}~\cite{Peierls.1929,Hardy.1963,Isaeva.2019}.

\subsection{Thermal conductivity derived from the harmonic flux}
\label{sec:hf.kappa.ha}
{With the harmonic heat flux at hand}, we are now in position to discuss certain limits of the resulting thermal conductivity. For example, it is straightforward to show that the thermal conductivity of a purely harmonic system is infinite. 
%At the same time, useful approximations to compute the thermal conductivity from a perturbation theory perspective can be found. 
We demonstrate the reasoning for the case of the diagonal contribution to the heat flux $\b J_{\rm ha-diag}$ given by Eq.\,\eqref{eq:J.ha.diag}, which we simply denote by $J$ in the following, omitting Cartesian components for clarity when no confusion can arise.
% The additional terms stemming from the offdiagonal contribution to the heatflux have been worked out in Ref.\,\cite{Isaeva.2019}.

\newthought{As discussed in detail in Sec.\,\ref{sec:Thermal.Conductivity}}, the thermal conductivity is given by the Kubo formula
\begin{align}
	\kappa
		&=
		\frac{V}{k_{\rm B} T^2} \int_{0}^{\infty} 
		\d t \braket{J (t) J} ~,
	\label{eq:flux.ha.k}
\end{align}
where the last quantity in $\braket{\cdot}$ will be evaluated at $t=0$.
The autocorrelation function for the diagonal harmonic heat flux defined in Eq.\,\eqref{eq:J.ha.diag} reads
\begin{align}
	\braket{J(t) J} 
		&= \frac{1}{V^2} \sum_{ss'} v_{\fP s} v_{s'}
			\braket{E_s (t) E_{s'}}~,
%		&= \frac{1}{V^2} \sum_{ss'} \braket{E_s E_{s'}}  v_{s} v_{s'}
%			\frac{\braket{E_s (t) E_{s'}}}{\braket{E_s E_{s'}}}~.
	\label{eq:ha.kappa.dJ.corr}
\end{align}
where the $E_s (t)$ are chosen such that $\braket{E_s} = 0$. The thermal conductivity is obtained by integrating the autocorrelation function. We get
\begin{align}
	\kappa^{\alpha \beta}
		= V \sum_{ss'} \fD c_{ss'} v^\alpha_{\fP s} v^\beta_{s'} \fD \tau_{ss'}~,
	\label{eq:kappa_ss}
\end{align}
%with $c_{ss'} = 1/k_{\rm B}T^2 \braket{n_s} \omega_s \braket{n_{s'}} \omega_{s'}$, 
where we define the generalized lifetime
\begin{align}
	\tau_{ss'} 
		=	\int_{0}^{\infty} \d t ~ G_{ss'} (t)
	\label{eq:tau_ss}
\end{align}
with the normalized mode-energy autocorrelation function\footnote{The $-1$ comes from choosing $\braket{E_s} =0$~.}
\begin{align}
	G_{ss'} (t)
		= \frac{\braket{E_s (t) E_{s'}}}{\braket{E_s E_{s'}}}
	  = \frac{\braket{\D a_s (t) \fD{a}_s (t) \D a_{s'} \fD a_{s'}}}{\braket{n_s} \braket{n_{s'}}} - 1~,
	\label{eq:G_ss}
\end{align}
and the generalized heat capacity
\begin{align}
	c_{ss'} = \frac{1}{k_{\rm B} T^2} \braket{E_s E_{s'}}~.
	\label{c_ss}
\end{align}

\newthought{In the perfectly harmonic case}, the mode-energy autocorrelation function $G_{ss'}$ can be evaluated analytically by noting that the expectation value $\braket{\cdot}$ can be viewed as a functional integral with the distribution function $f = {\rm e}^{-\beta \sum_s \omega_s \D a_{s} \fD a_{s}}$ and can therefore be evaluated by means of a Wick theorem~\cite{Isaeva.2019}.
Keeping only the non-vanishing pairings, we have\footnote{In the context of complex field integration, the Wick theorem reads~\cite{NegeleOrland}
%
\begin{align*}
  \braket{ABCD} 
    &= \braket{AB}\braket{CD} \\
    &~ + \braket{AC}\braket{BD} \\
    &~  + \braket{AD}\braket{BC}~.
\end{align*}
%
 Pairings with a non-equal number of ``creators'' $\D a$ and ``annihilators'' $a$ vanish identically because of the symmetry of the distribution function $f$.}
\begin{align}
	\braket{\D a_s (t) \fD{a}_s (t) \D a_{s'} \fD a_{s'}}
		= \braket{n_s} \braket{n_{s'}} + \fD g_s (t) g^\ast_{s} (t) \delta_{ss'}~,
	\label{eq:ha.kappa.wick}
\end{align}
where $\braket{n_s} = \frac{k_{\rm B} T}{\omega_s}$
%\begin{align}
%	\braket{n_s} = \frac{k_{\rm B} T}{\omega_s}
%\end{align}
is the equipartition mode occupation, and the one-particle Green's function $g_s (t)$ is defined by
\begin{align}
	g_s (t) \delta_{ss'}
		\equiv \braket{\D{a}_{\fP s} (t) \fD{a}_{s'}} 
		= {\rm e}^{\im \omega_s t} \braket{n_s} \delta_{ss'}~,
\end{align}
where the time evolution of the complex amplitudes $a^{\dagger}_s (t) = {\rm e}^{\im \omega_s t} \D a_s$ was used.
It is apparent that the product $g_s(t) g^\ast_s(t)$ is not time-dependent, and the heatflux autocorrelation function defined in Eq.\,\eqref{eq:ha.kappa.dJ.corr} is therefore given by
\begin{align}
	\braket{J (t) J} = \sum_s \braket{J_s^2}~.
	\label{eq:ha.kappa.JJ}
\end{align}
Consequently, the harmonic heatflux autocorrelation function integrates to infinity and the thermal conductivity $\kappa$ diverges.

\newthought{A finite thermal conductivity} is obtained when the phonons are allowed to interact, for example by introducing impurities, electron-phonon interactions, or self interactions via anharmonic contributions to the potential-energy surface. If the perturbation is weak, it can be expressed by modified Green's functions~\cite{NegeleOrland}
\begin{align}
	g_s (t) = {\rm e}^{\im \left( \omega_s + \Sigma_s \right) t} \braket{n_s}~,
	\label{eq:ha.kappa.g.self}
\end{align}
where $\Sigma_s$ is the phonon self energy. Assuming the self energy to be purely imaginary, $\Sigma_s = \im \Gamma_s$, we have
\begin{align}
	G_{s} (t) = \frac{\fD g_s (t) g^\ast_{s} (t)}{\braket{n_s}^2} = {\rm e}^{- 2 \Gamma_s t}
	\equiv {\rm e}^{-t / \tau_s} ~,
	\label{eq:ha.kappa.gg.Sigma}
\end{align}
where he have defined the lifetime $\tau_s = 1 / 2 \Gamma_s$. The heatflux autocorrelation function now reads
\begin{align}
	\braket{J (t) J} = \sum_s \braket{J_s^2} {\rm e}^{-t / \tau_s}~,
	\label{eq:ha.kappa.JJ.pert}
\end{align}
and the thermal conductivity integrates to a finite value given by\footnote{Using \begin{align*}
		J_s 
			&= \omega_s v_s n_s~,\\
		\braket{n_s} 
			&= \frac{k_{\rm B} T}{\omega_s}~.
	\end{align*}}
\begin{align}
	\kappa_{\rm ha}^{\alpha \beta} = V k_{\rm B} \sum_{s} v^\alpha_s v^{\beta \vphantom{\dagger}}_s \fD \tau_s~,
	\label{eq:ha.kappa.bte}
\end{align}
which is the single-mode $(s=s')$ approximation to the general $\kappa$ defined in Eq.\,\eqref{eq:kappa_ss} with the classical value for the mode heat capacity $c_s = k_{\rm B}$.

The same expression can be found from a Boltzmann transport approach using the \emph{single-mode relaxation-time approximation}, and extension to quantum-mechanical distributions is straighforward~\cite{Srivastava}.

\subsection{Mode lifetimes from perturbation theory}
In low-order perturbation theory, the phonon self energy can be obtained by approximating the potential-energy surface as
%
\begin{align}
	\mathcal{V} (\b R) \approx V^{(2)} (\b R) + V^{(3)} (\b R)~,
	\label{eq:V3}
\end{align}
%
where $V^{(2)} (\b R)$ denotes the harmonic potential, and $V^{(3)} (\b R)$ is obtained by expanding the potential $\mathcal V (\b R)$ to third order. Further assuming the cubic contribution $V^{(3)} (\b R)$ to be small compared to the harmonic part, the inverse mode lifetime $\tau_s^{-1} = 2 \Gamma_s$ is given by the Fermi Golden Rule expression~\cite{Maradudin.1962,Cowley.1963}
%
\begin{align}
\begin{split}
	2 \Gamma_{s}=\frac{\pi \hbar^{2}}{4 \omega_{s}} \sum_{pq} \frac{\left|\mathcal V^{(3)}_{spq}\right|^{2}}{\omega_{p} \omega_{p}}
		&\left[ 
	  \frac{1}{2}\left(1+n_{p}+n_{l}\right) \delta\left(\omega_{s}-\omega_{p}-\omega_{q}\right) \right. \\
		&\left.~~~~ \phantom{\halb} + \left(n_{p}-n_{q}\right) \delta\left(\omega_{s}+\omega_{p}-\omega_{q}\right)\right]~,
\end{split}
\label{eq:Gamma_s}
\end{align}
%
where $\mathcal V^{(3)}_{spq}$ is the cubic potential transformed to phonon eigenstates. This equation and the single-mode expression for $\kappa$, Eq.\,\eqref{eq:ha.kappa.bte}, serve as the basis for most \emph{ab initio} studies of thermal conductivity in insulating solids in recent years~\cite{Broido.2007,Simoncelli.2019,Isaeva.2019}.\sidenote[][-3em]{The lifetime expression in Eq.\,\eqref{eq:Gamma_s} is modified when the full linearized Boltzmann transport equation is solved without performing the single-mode relaxation time approximation, where momentum-preserving phonon collisions (normal processes) are neglected~\cite{Klemens.1958,Omini.1996,Omini.1997,Broido.2005}. These are typically small for thermal insulators, however they can be of particular importance in highly conducting solids and two-dimensional systems~\cite{Lindsay.2010,Fugallo.2014,Cepellotti.2016}. \label{foot:SMRTA}} 
More recently, extensions of the perturbation-expansion approach up to fourth order have been presented~\cite{Feng.2016,Feng.2017,Ravichandran.2018,Xia.2018}. While higher-order perturbation theory can improve the description of heat transport in anharmonic solids~\cite{Xia.2020,Ravichandran.2020}, it's applicability is currently limited to simple, highly-symmetric materials because of the scaling of quartic force constants with system size, see the discussion in appendix D of Ref.~\cite{Ravichandran.2018}. The matter of third- and fourth-order scattering is further discussed in Sec.\,\ref{sec:anharmonicity.bte} below.


\subsection{Mode lifetimes from molecular dynamics simulations}
In \emph{ab intio} molecular dynamics, we have direct access to the non-perturbative dynamics of the nuclear system. Lifetimes can therefore be extracted by straightforward application of Eq.\,\eqref{eq:tau_ss} and \eqref{eq:G_ss}~\cite{Ladd.1986}. To circumvent the problem of brute-force integrating the time integral in the evaluation of the lifetime expression in Eq.\,\eqref{eq:tau_ss}, we use the analytic Green's function expression defined in Eq.\,\eqref{eq:ha.kappa.gg.Sigma} to approximate the normalized mode-energy autocorrelation function $G_{ss'} (t)$ as
%
\begin{align}
	G_{ss'} (t) \approx G_s (t) \delta_{ss'} = \frac{\braket{E_s (t) E_s}}{\braket{E^2_s}}
		\approx  {\rm e}^{-t / \tau_s}~,
	\label{eq:G_s}
\end{align}
%
from which the lifetime $\tau_s$ can be obtained by fitting $G_s (t)$ to an exponential function. 
%
%\REM{Interpolation here?}
%\REM{Remove plot?}
%\mscomment{explain better}
%\mscomment{explain non straight line behavior}
%%
%%
%\REM{strictly speaking not the same as SMRTA, see \cite[p.\,29]{Klemens.1958}}
%%
%\mscomment{how good is single-mode approximation?}
%\FK{it depends, afaik mostly in high $\kappa$ materials}
%\ADD{Discussion, e.g. Marzari relaxon papers?}


\section{Ab initio Green Kubo}
\label{sec:aiGK}
Building on the previous sections, we are now in position to shortly sketch the \emph{ab initio} Green Kubo approach adopted in this work~\cite{Carbogno.2016}, before introducing the methodological details in more depth later in Chp.\,\ref{chp:implementation}. The approach comprises four steps:
\begin{enumerate}
	\item The thermal conductivity $\kappa_{\rm ai}$ is obtained by numerically evaluating the Green-Kubo integral using the \emph{ab initio} heat flux ${\bf J}_{\rm ai} (t)$ defined in Eq.\,\eqref{eq:J_ai} evaluated during microcanonical \emph{ab initio} molecular dynamics simulations.
	\item The harmonic contribution $\kappa_{\rm ha}$ to the thermal conductivity is computed from the simulation data by using lifetimes extracted via Eq.\,\eqref{eq:G_s} in the BTE-type formula for $\kappa_{\rm ha}$ given in Eq.\,\eqref{eq:ha.kappa.bte}.
	\item The quantities used to compute $\kappa_{\rm ha}$,~i.\,e., the group velocities and lifetimes, are interpolated to dense q-point grids in reciprocal space to achieve an extrapolation of the harmonic thermal conductivity to bulk limit, $\kappa_{\rm ha-bulk}$~\cite{Carbogno.2016}. The interpolation works by assuming that\marginnote{We temporarily restore the full notation \mbox{$s=(b, {\bf q})$} to make the q-dependence of the appearing quantities explicit.} $\fD \tau_b ({\bf q}) = \fD \lambda_b ({\bf q}) \omega_b^{-2} ({\bf q})$ with a weakly q-dependent function $\lambda_b ({\bf q})$ obtained by linearly interpolating the lifetimes obtained at commensurate q-points. The scaling of lifetimes with $\omega_s^{-2}$ is rooted in basic phonon theory as developed by Herring~\cite{Herring.1954} and holds especially for long-ranged acoustic modes which are difficult to describe in finite-sized \emph{ab initio} molecular dynamics simulations. A more detailed account of the interpolation scheme is given in Sec.\,\ref{sec:imp.extrapolation}.
	\item The interpolation scheme yields a finite-size corrected thermal conductivity via
	\begin{align}
		\kappa_{\rm bulk}  = \kappa_{\rm ai} - \kappa_{\rm ha} + \kappa_{\rm ha-bulk}~.
		%\delta \kappa_{\rm bulk} = \kappa_{\rm ha-bulk} - \kappa_{\rm ha}~.
		%\label{eq:dkappa_bulk}
		\label{eq:kappa_bulk}
	\end{align}
%	%
%	\mscomment{was this explained?}
%	\FK{this is the explanation, clarify wording}
\end{enumerate}



\section{Conclusion}
It is apparent from the presentation above that a low-order expansion of the potential-energy surface combined with low-order perturbation expressions represents a wealth of approximations that certainly hold for some materials~\cite{Ladd.1986,Broido.2007,Puligheddu.2019}, but are questionable or even outright unjustified for others. In particular, dynamical effects such as phase transitions to dynamically stabilized crystal structures (ZrO$_2$~\cite{Carbogno.2014,Carbogno.2016}, SrTiO$_3$~\cite{Tadano.2015}), spontaneous defect formation (e.\,g., in noble metal halides~\cite{Ulrich.1999,Brenner.2020}), or simply a soft bonding and therefore strong anharmonicity (NaCl~\cite{Ravichandran.2018}, NaBr~\cite{Shen.2020}) are inherently absent in such a description. These are cases where a non-perturbative description of thermal transport is necessary. By the same argument, largely harmonic materials like silicon or diamond fulfill the requirements for a perturbative treatment, and brute-force simulating the nuclear dynamics via MD techniques is therefore not necessary.

\newthought{For these reasons, it is desirable to pre-categorize materials} in terms of their ``anharmonic strength'', especially when one attempts to screen materials space for a significant amount of materials, as this allows to choose appropriate simulation techniques for each system. We present a systematic approach towars ``measuring anharmonicity'' in the next chapter.
