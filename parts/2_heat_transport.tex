\subsection{Heat Transport}
\subsubsection{Linear Response Theory}
\cite{Einstein1905a,Onsager1931a,Onsager1931b,Kubo1957a,Kubo1957b}
\cite[p. 68]{Lomen1986} \cite{Tuckerman}

In order to establish the famous Green-Kubo relation for computing the non-equilibrium transport coefficients from equilibrium fluctuations of the corresponding flux,~i.\,e.,~by means of the fluctuation-dissipation theorem, we briefly review linear response theory for classical statistical mechanics. We do so by starting from a general Hamiltonian $H$ that is given in terms of the many-body Hamiltonian
\begin{align}
  H^0 (\Gamma) 
    = H^0(\set{\b R, \b P})
    = \sum_I \frac{\b P^2}{2 M_I} + V (\b R)~,
  \label{eq:lr.H0}
\end{align}
and some yet unspecified external perturbation $H'$. We write the full Hamiltonian as
\begin{align}
  H (\Gamma, t)
   = H^0 (\Gamma) + \lambda H' (\Gamma, t)~,
  \label{eq:lr.H}
\end{align}
where the perturbation is given by an external force $F(t)$ coupled to the system through a phase-space operator $A (\Gamma)$,
\begin{align}
  H' (\Gamma, t) = A (\Gamma) F (t)~,
  \label{eq:lr.H'}
\end{align}
with a bookkeeping parameter $\lambda = 1$ that we introduce to count the order in the perturbation $A$.

The canonical distribution function for the unperturbed system reads
\begin{align}
  f^0 (\Gamma) 
    = \frac{1}{\mathcal{Z}^0} {\rm e}^{- \beta H^0 (\Gamma)}~,
  \label{eq:lr.f0}
\end{align}
where the partition sum $\mathcal{Z}_0$ normalizes the phase-space integral, \mbox{$\int \d \Gamma f^0 (\Gamma) = 1$}.
We write the distribution function in presence of the perturbation as
\begin{align}
  f (\Gamma, t) = f^0(\Gamma) + \lambda \Delta f (\Gamma, t)~,
  \label{eq:lr.f}
\end{align}
where $\Delta f$ is the perturbation in the distribution generated by $H'$. Using that $f^0$ carries no explicit time dependence, the Liouville equation for $\Delta f$ reads~\cite[p. 68]{Tuckerman}
\begin{align}
  \lambda \frac{\d \Delta f}{\d t}
    &= \set{H, f} \nonumber \\
    &= \lambda \set{H^0, \Delta f} 
      + \lambda \set{A, f^0} F(t)
      + \mathcal{O}(\lambda^2)~,
  \label{eq:lr.df.1} \\
  \implies
    \frac{\d \Delta f}{\d t}
      &\approx \braket{H^0 , \Delta f} + \set{A, f^0} F(t)
  \label{eq:lr.df.2}
\end{align}
where $\set{\cdot , \cdot}$ denotes the Poisson bracket\footnote{
  The Poisson bracket for a system of particles with $3N$ positions $q_i \equiv R_I^\alpha$ and conjugate momenta $p_i \equiv P_I^\alpha$ reads
  $$
  \set{A, B} = \sum_{i}
  \frac{\partial A}{\partial q_i} \frac{\partial B}{\partial p_i}
  - \frac{\partial A}{\partial p_i} \frac{\partial B}{\partial q_i}~.
  $$
  }, 
and in Eq.\,\eqref{eq:lr.df.2} we only keep the terms to linear order in the perturbation, hence we compute the \emph{linear response}.
To solve for $\Delta f(t)$, we introduce a shorthand notation such that
\begin{align}
  \frac{\d \Delta f}{\d t} = -\im L \Delta f(t) - \im \Delta L (t) f^0~,
  \label{eq:lr.df.3}
\end{align}
where the Liouville operator $L^0$ is defined by
\begin{align}
  \im L^0 g = \set{g, H^0}~,
  \label{eq:lr.L}
\end{align}
and similarly
\begin{align}
  \im \Delta L (t) g = \set{g, H'(t)}~.
  \label{eq:lr.L'}
\end{align}
Equation~\eqref{eq:lr.df.3} is a first order linear differential equation of the form
\begin{align}
  \frac{\d y}{\d t} + p(t) y = q(t)~,
  \label{eq:lr.dgl.1}
\end{align}
which is straightforward to solve by using an integrating factor\footnote{Identify $y = \Delta f$, $p(t) = \im L^0$, and $q(t) = - \im \Delta L (t) f^0$. Following Ref.~\cite[p.\,68]{Lomen1986}, we define the integrating factor \mbox{$\rho (t) = \exp(\int \d t \, p (t)) = \exp (\im L^0 t)$}, multiply Eq.\,\eqref{eq:lr.dgl.1} with $\rho (t)$, and use that \mbox{$\d/\d t \, \rho(t) = \rho(t) p(t)$} to obtain
  $$
  \frac{\d}{\d t} (\rho (t) y) = \rho(t) q(t)~.
  $$
  This gets integrated to
  $$
  \rho(t) y = \int_{-\infty}^t \d t' \, \rho(t') q(t')
  $$
  under the boundary condition $y (t \to -\infty) = 0$. In total we obtain
  $$
  y(t) = \rho^{-1} (t) \int_{-\infty}^t \d t' \, \rho(t') q(t')
  \implies
  \Delta f(t) 
    = - {\rm e}^{- \im L^0 t}  \int_{-\infty}^t \d t' \, {\rm e}^{\im L^0 t'} \im \Delta L (t') f^0~.
  $$
  }, and yields~\cite{Kubo1957a}
\begin{align}
  \Delta f (t) 
    = \int_{-\infty}^t {\rm e}^{-\im L^0 (t - t')} \set{A, f^0} F(t')~\d t'~.
  \label{eq:lr.df(t)}
\end{align}
This expression can be simplified in the canonical ensemble by using that \mbox{$\partial f^0 / \partial H^0 = -\beta f^0$}, which leads to
\begin{align*}
  \set{A, f^0}
    &= \sum_i \frac{\partial A}{\partial q_i} \frac{\partial f^0}{\partial p_i}
    - \frac{\partial A}{\partial p_i} \frac{\partial f^0}{\partial q_i} \\
    &= \sum_i \frac{\partial A}{\partial q_i} \frac{\partial f^0}{\partial H^0} \frac{\partial H^0}{\partial p_i}
    - \frac{\partial A}{\partial p_i} \frac{\partial f^0}{\partial H^0} \frac{\partial H^0}{\partial q_i} \\
    &= -\beta f^0 \sum_i
      \left( \frac{\partial A}{\partial p_i} \dot{q}_i +  \frac{\partial A}{\partial q_i} \dot{p}_i \right) \\
    &= -\beta f^0 \, \frac{\d A}{\d t}~,
\end{align*}
where in the second step Hamilton's equations of motion have been used.

We are now in position to formulate the expected response of a phase space observable $B$ in the presence of a perturbation described by the Hamiltonian $H'$,~i.\,e.,~
\begin{align}
  \Delta B (t) 
    &= \int \d \Gamma ~  B (\Gamma) \Delta f (\Gamma, t) \\
    &= - \beta \int_{-\infty}^t 
      \int \d \Gamma ~ f^0(\Gamma) \, 
       B (\Gamma) \, {\rm e}^{-\im L^0 (\Gamma) (t - t')} \dot{A}(\Gamma) F(t') ~ \d t' \\
    &= - \beta \int_{-\infty}^t 
      \braket{B(t) \dot{A}(t')}_0 F(t') ~ \d t'~,
  \label{eq:lr.dB}
\end{align}
where it was used that $a(t) = {\rm e}^{\im L^0 t} a(0) = a(0) {\rm e}^{-\im L^0 t}$~\cite[p.\,498]{Tuckerman}, and $\braket{\cdot}_0$ denotes a phase-space average with respect to the unperturbed distribution function $f^0 (\Gamma)$.

\paragraph{Conserved densities and currents}
Macroscopic properties of matter are often \emph{extensive},~i.\,e.,~they scale with the system size, and can be described by a locally conserved \emph{density}. Taking the general property $A$ represented by the phase-space observable $A(\Gamma_t)$ evaluated at a time $t$ as an example, we define
\begin{align}
  A (\Gamma_t) = \int_V a (\b r, \Gamma_t) \, \d^3 r~,
  \label{eq:lr.A}
\end{align}
where $a(\b r, \Gamma_t)$ is the \emph{local density} associated with the observable $A$. The notation $\Gamma_t$ highlights that the quantity is implicitly time-dependent because the phase-space point $\Gamma$ evolves in time.\footnote{
	Notation for phase-space functions $f (\Gamma)$:
	\begin{align}
	f(t) &\equiv f(\Gamma (t)) \\
	\frac{\partial f}{\partial t} &= \frac{\d f (\Gamma (t))}{\d t} \equiv \dot{f}(t)
	\end{align}
	} 
When no ambiguity arises, we can therefore just write $a (\b r, t)$. The locally conserved density fulfills a continuity equation
\begin{align}
  \partial_t \, a(\b r, t) = - \b \nabla \cdot \b j_a (\b r, t)~,
  \label{eq:lr.continuity.1}
\end{align}
where $\b j_a (\b r, t)$ is the associated current. From the local current, the macroscopic flux is obtained by spatially averaging over the system volume,
\begin{align}
  \b J (t)
    = \frac{1}{V} \int_V \d^3 r ~ \b j (\b r, t)~,
  \label{eq:lr.J(t)}
\end{align}
where the subscript $a$ was dropped for notational clarity.
Likewise we formulate a local version of the perturbing Hamiltonian \mbox{$H' = A (\Gamma) F(t)$} in the form
\begin{align}
	H' (\Gamma, t) = \int \d^3 r ~ a (\b r, \Gamma) v(\b r, t)~,
	\label{eq:lr.H'}
\end{align}
where $a(\b r, \Gamma)$ represents the density of interest as introduced above, and $v(\b r, t)$ is the local driving force coupling to the system via the density $a (\b r, \Gamma)$.

The local version of linear-response formula given in Eq.\,\eqref{eq:lr.dB} with \mbox{$\Delta B = B \equiv \b J$} ($\braket{\b J} = 0$) reads:
\begin{align}
j^\alpha (\b r , t) 
	& \equiv \braket{j^\alpha (\b r)}_{\Delta f (t)} \\
	&= - \beta \int_{-\infty}^{t} \d t' \int_V \d^3 r' ~ \braket{
			j^\alpha (\b r, \Gamma_t) \dot{a} (\b r', \Gamma_{t'})
		}_0 v (\b r', t')~.
	\label{eq:lr.ja.1}
\end{align}
The time derivative of the density can be eliminated by using the continuity equation~\eqref{eq:lr.continuity.1}, $\dot a = \partial'_\beta j^\beta$ where $\partial'_\beta = \partial/\partial r^{\prime \beta}$, and integrating by parts, so that
\begin{align}
j^\alpha (\b r , t) 
&= - \beta \int_{-\infty}^{t} \d t' \int_V \d^3 r' ~ \braket{
	j^\alpha (\b r, \Gamma_t) j^\beta (\b r', \Gamma_{t'})
}_0 \partial'_\beta v (\b r', t')~.
\label{eq:lr.ja.2}
\end{align}
If we now assume the external driving force $v (\b r, t)$ to be constant in time and homogeneously varying in space such that
\begin{align}
	\partial_\beta v (\b r, t) \equiv f_\beta~,
	\label{eq:lr.force}
\end{align}
and spatially average over Eq.\,\eqref{eq:lr.ja.2} with $\frac{1}{V} \int_V \d^3 r$, we arrive at
\begin{align}
	J^\alpha 
		&= -\beta V \int_{0}^{\infty} 
		\d t
		\braket{
		J^\alpha (\Gamma_t) J^\beta (\Gamma_{0})
	}_0 
	f_\beta~,
	\label{eq:lr.J}
\end{align}
where the stationarity in time was used to shift the lower bound of the integral to $t=0$.
This resembles the well-known macroscopic transport equation
\begin{align}
	J^\alpha =  L^{\alpha \beta} F_\beta~,
		\label{eq:lr.LF}
\end{align}
with
\begin{align}
	L^{\alpha \beta}
		= \frac{V}{k_{\rm B}} \int_{0}^{\infty} 
		\d t \braket{J^\alpha (\Gamma_t) J^\beta (\Gamma_{0})}_0 ~,
	\label{eq:lr.L}
\end{align}
and
\begin{align}
	F_\beta
		= - \frac{f_\beta}{T}~,
	\label{eq:lr.F}
\end{align}
where $J^\alpha$ is the macroscopic generalized current associated with the extensive property $A$, $F_\beta$ is the thermodynamic force, and $L^{\alpha \beta}$ is the associated conductance tensor~\cite{Onsager1931a,Baroni2020a}.

\paragraph{Thermal Conductivity}
After this general exposition, let us now look at the example of the total energy of the system and it's associated energy density,
\begin{align}
	E = \int_V \d^3 r ~ e(\b r)~.
	\label{eq:lr.E}
\end{align}
We are interested in the occuring flux in the presence of a temperature inhomogeneity, which we model by
\begin{align}
	H' (\Gamma) = \frac{1}{T} \int \d^3 r ~ \Delta T (\b r) e(\b r, \Gamma)~,
	\label{eq:lr.Hp.temp}
\end{align}
so that
\begin{align}
	f_\beta = \frac{1}{T} \partial_\beta T (\b r) 
		\stackrel{\eqref{eq:lr.F}}{\implies}
	F_\beta = - \frac{1}{T^2} (\b \nabla T)_\beta ~.
	\label{eq:lr.F.temp}
\end{align}
Using the general transport equation $\b J = L \b F$ with the conductance given by Eq.\,\eqref{eq:lr.L} and $F$ as defined above, we obtain
\begin{align}
	J^\alpha 
		&= - \kappa^{\alpha \beta} (\b \nabla T)_\beta~,
	\label{eq:lr.J.2}
\end{align}
where $\kappa^{\alpha \beta}$ denotes the \emph{thermal conductivity tensor} defined as
\begin{align}
	\kappa^{\alpha \beta}
		&=
		\frac{V}{k_{\rm B} T^2} \int_{0}^{\infty} 
		\d t \braket{J^\alpha (\Gamma_t) J^\beta (\Gamma_{0})}_0 ~.
	\label{eq:GreenKubo}
\end{align}

\subsubsection{Heat Flux Definition}
In order to evaluate the thermal conductivity by means of the Green-Kubo formula, Eq.\,\eqref{eq:GreenKubo}, the  heat flux observable $\b J (\Gamma)$ needs to be defined. We do so by starting from the continuity equation again,
\begin{align}
	\dot{e} (\b r) = - \b \nabla \cdot \b j (\b r)
	\label{eq:hf.cont}
\end{align}
and perform a space Fourier transform defined by the pair of equations
\begin{align}
	e(\b r) 
		&= \int \d^3 q ~ e(\b q) \, {\rm e}^{\im \b q \cdot \b r} ~,
		\label{eq:hf.ft.r} \\
	\Leftrightarrow
	e(\b q) 
		&= \frac{1}{V} \int \d^3 r ~ e(\b r) \, {\rm e}^{-\im \b q \cdot \b r} ~,
	\label{eq:hf.ft.2}
\end{align}
so that the continuity equation can be rewritten for the Fourier components as
\begin{align}
	\dot{e} (\b q)
		= - \im \b q \cdot \b j (\b q)~.
	\label{eq:hf.ft.cont.q}
\end{align}
We split the total current into a longitudinal, heat-carrying component $\b j_{\parallel}$ and a transverse current $\b j_{\perp}$,
\begin{align}
	\b j = \frac{\b q}{q} j_{\parallel} + \b j_{\perp} \quad\text{where}\quad \b q \cdot \b j_{\perp} = 0~,
\end{align}
so that
\begin{align}
	\b j_{\parallel} 
		= -\im \frac{\b q}{q^2} \dot{e} (\b q)~.
\end{align}
As before, we obtain the macroscopic heat flux as a spatial average of the (longitudinal) current,
\begin{align}
	\b J (t) = \frac{1}{V} \int \d^3 r ~ \b j_{\parallel} (\b r) = \b j_{\parallel} (\b q \to 0)~,
	\label{eq:hf.J.1}
\end{align}
i.\,e.,~the long wavelength limit of the current in reciprocal space. The long wavelength limit for the time derivative of the local energy density is
\begin{align}
	\dot{e} (\b q \to 0) 
		= \lim_{\b q \to 0} \int \d^3 r \left(\cancel{1} - \im \b q \cdot \b r + (\b q \cdot \b r)^2 + \cdots \right) \dot{e} (\b r)~,
	\label{eq:hf.e.lw}
\end{align}
where the first term in the expansion is excluded since the total energy $E$ is conserved in time.\footnote{
\begin{align}
	\int \d^3 r \, \dot{e} (\b r) = \frac{\d}{\d t} \int \d^3 r \, e (\b r) = \frac{\d}{\d t} E = 0
	\quad\text{by Leibniz rule.}
\end{align}
}
From the first non-vanishing term, we obtain
\begin{align}
	\b J (t) = \frac{1}{V} \int \d^3 r ~ \b r \, \dot{e} (\b r)~,
	\label{eq:hf.J}
\end{align}
i.\,e.,~the heat flux is given as the first moment of the time derivative of the local energy density. When the energy density is split into atomic contributions as
\begin{align}
	e (\b r, t ) = \sum_I E_I (t) \delta (\b r - \b R_I)~,
	\label{eq:hf.e.atomic}
\end{align}
the flux is given by
\begin{align}
	\b J (t) 
		= \frac{1}{V} \frac{\d}{\d t} \sum_I E_I(t) \b R_I(t)
		= \frac{1}{V} \sum_I \dot{E}_I (t) \b R_I (t) + E_I (t) \dot{\b R}_I (t)~.
	\label{eq:hf.J.atomic}
\end{align}

\paragraph{Gauge invariance}
As seen above, the local current is only defined up to a non-heat carrying contribution $\b j_{\perp}$. Likewise, the energy density is only defined up to terms that keep the total energy integral unchanged. The choice of a local energy partitioning as,~e.\,g.,~given by Eq.\,\eqref{eq:hf.e.atomic} is therefore not unique, and different partitioning schemes will lead to differing heat fluxes. However, the thermal conductivity obtained by these heat fluxes will be the same in the long time limit~\cite{Ercole2016}.

\subsubsection{Ab initio Heat Flux}
The above formulas are readily applied when empirical force fields are used to describe the atomic interactions, as an atomic partitioning of the total energy is trivial in that case, although care must be taken in deriving the correct formulae nevertheless~\cite{Fan2015,Boone2019}. An \emph{ab initio} derivation of heat flux on the other hand was a long-standing problem because it was not clear how an expression of the form Eq.\,\eqref{eq:hf.J} or Eq.\,\eqref{eq:hf.J.atomic} can be obtained when no atomic partitioning is available. This problem was solved when Marcologno \emph{et al.} and Carbogno \emph{et al.} independently of each other arrived at well-defined heat flux expressions in \emph{ab initio} frameworks~\cite{Marcolongo2016,Carbogno2016}. We adopt the latter approach in the following and review derivation shortly.

\REM{arg1}

\subsubsection{Ab initio Green Kubo}